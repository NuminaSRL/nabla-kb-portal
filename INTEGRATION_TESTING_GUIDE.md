# KB Portal Integration Testing Guide

## Overview

This guide provides comprehensive instructions for testing the integration between KB Portal and the main NABLA system.

## Prerequisites

Before running integration tests, ensure:

1. **Supabase Database:**
   - Database is running and accessible
   - All migrations have been applied
   - Sample data is loaded (optional but recommended)

2. **EmbeddingGemma Service:**
   - Service is deployed and running on Railway
   - Health endpoint responds correctly
   - API is accessible from test environment

3. **Environment Variables:**
   - All required variables are set in `.env.local`
   - Variables match across KB Portal and MCP Server
   - URLs are correct and accessible

4. **Dependencies:**
   - Node.js 18+ installed
   - npm packages installed (`npm install`)
   - TypeScript compiler available

## Running Integration Tests

### Automated Tests

Run the automated integration verification script:

```bash
cd kb-portal
npm run test:integration
```

Or run directly with ts-node:

```bash
cd kb-portal
ts-node scripts/verify-integration.ts
```

### Manual Tests

#### Test 1: Shared Database Access

**Objective:** Verify both KB Portal and MCP Server access the same database.

**Steps:**
1. Open KB Portal in browser: `http://localhost:3000`
2. Sign up for a new account
3. Verify user appears in Supabase dashboard under `auth.users`
4. Check `user_profiles` table for corresponding profile
5. Generate API key for MCP Server
6. Verify API key appears in `api_keys` table

**Expected Result:**
- User created in both `auth.users` and `user_profiles`
- API key linked to user ID
- Same Supabase project ID in both systems

#### Test 2: Unified Authentication

**Objective:** Verify authentication works across all portals.

**Steps:**
1. Sign up in KB Portal with email/password
2. Log out from KB Portal
3. Log in to Admin Portal with same credentials
4. Verify session is valid
5. Generate API key in Admin Portal
6. Use API key to call MCP Server endpoint
7. Verify user ID matches across all systems

**Expected Result:**
- Same credentials work in KB Portal and Admin Portal
- API key linked to correct user
- Session tokens valid across portals

#### Test 3: Consistent Embedding Generation

**Objective:** Verify embeddings are consistent across systems.

**Steps:**
1. In KB Portal, search for "GDPR compliance"
2. Note the search results and relevance scores
3. Using MCP Server, call `search_kb` with same query
4. Compare results from both systems
5. Verify relevance scores are identical

**Expected Result:**
- Same documents returned in same order
- Relevance scores match exactly
- Processing time similar (<100ms difference)

#### Test 4: Cross-Portal User Experience

**Objective:** Verify seamless experience when switching between portals.

**Steps:**
1. Log in to KB Portal
2. Perform several searches
3. Save a search
4. Open Admin Portal (if authorized)
5. Verify saved searches appear
6. Approve a document in Admin Portal
7. Return to KB Portal
8. Search for newly approved document
9. Verify it appears in results

**Expected Result:**
- Saved searches accessible across portals
- Document approval immediately reflected
- No data synchronization lag
- Session remains valid

#### Test 5: Shared Analytics

**Objective:** Verify usage tracking works across all systems.

**Steps:**
1. Log in to KB Portal
2. Perform 5 searches
3. Check usage dashboard
4. Note search count
5. Use MCP Server API to perform 3 more searches
6. Return to KB Portal usage dashboard
7. Verify total shows 8 searches

**Expected Result:**
- Usage tracked from both KB Portal and MCP Server
- Total count accurate
- Quota calculations correct
- Real-time updates visible

## Integration Test Scenarios

### Scenario 1: New User Onboarding

**Flow:**
1. User signs up in KB Portal (Free tier)
2. User performs searches (within free tier limits)
3. User upgrades to Pro tier
4. User generates API key for MCP Server
5. User uses MCP Server with increased limits
6. User accesses Admin Portal (if Enterprise)

**Verification Points:**
- [ ] User profile created correctly
- [ ] Free tier limits enforced
- [ ] Upgrade reflected immediately
- [ ] API key has correct tier permissions
- [ ] MCP Server respects new limits
- [ ] Admin Portal access granted/denied correctly

### Scenario 2: Document Lifecycle

**Flow:**
1. Admin discovers new regulatory document
2. Document enters review queue
3. Admin approves document in Admin Portal
4. Embedding generated by EmbeddingGemma
5. Document stored in Supabase
6. User searches in KB Portal
7. Document appears in search results
8. User accesses via MCP Server
9. Document returned via API

**Verification Points:**
- [ ] Document in review queue
- [ ] Approval updates status
- [ ] Embedding generated (768-dim)
- [ ] Document in `documents` table
- [ ] Searchable in KB Portal
- [ ] Accessible via MCP Server
- [ ] Metadata consistent across systems

### Scenario 3: Quota Management

**Flow:**
1. Free tier user performs searches
2. User approaches daily limit
3. System shows quota warning
4. User hits limit in KB Portal
5. User tries MCP Server (should also be blocked)
6. User upgrades to Pro tier
7. Quota resets to Pro limits
8. User can search again in both systems

**Verification Points:**
- [ ] Quota tracked accurately
- [ ] Warning shown before limit
- [ ] Limit enforced in KB Portal
- [ ] Limit enforced in MCP Server
- [ ] Upgrade increases limits immediately
- [ ] New limits apply to both systems

### Scenario 4: Security and Audit

**Flow:**
1. User logs in to KB Portal
2. User performs sensitive search
3. User exports results
4. User logs out
5. Admin reviews audit log
6. Admin sees all user actions
7. Admin checks from both portals

**Verification Points:**
- [ ] Login event logged
- [ ] Search query logged
- [ ] Export action logged
- [ ] Logout event logged
- [ ] Audit log accessible in Admin Portal
- [ ] Timestamps accurate
- [ ] User ID consistent

## Performance Testing

### Load Test: Concurrent Searches

**Objective:** Verify system handles concurrent searches from multiple portals.

**Setup:**
```bash
# Install k6 for load testing
brew install k6  # macOS
# or
sudo apt-get install k6  # Linux
```

**Test Script:**
```javascript
// load-test-search.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  vus: 50, // 50 virtual users
  duration: '2m', // 2 minutes
};

export default function () {
  const queries = [
    'GDPR compliance',
    'Italian tax regulations',
    'AML requirements',
    'D.Lgs 231/2001',
    'AI Act implementation',
  ];
  
  const query = queries[Math.floor(Math.random() * queries.length)];
  
  const res = http.post(
    'http://localhost:3000/api/search',
    JSON.stringify({ query }),
    {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${__ENV.AUTH_TOKEN}`,
      },
    }
  );
  
  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
    'has results': (r) => JSON.parse(r.body).results.length > 0,
  });
  
  sleep(1);
}
```

**Run Test:**
```bash
k6 run load-test-search.js
```

**Expected Results:**
- 95% of requests complete in <500ms
- 99% of requests complete in <1000ms
- 0% error rate
- Consistent results across all requests

### Stress Test: Quota System

**Objective:** Verify quota system handles high load.

**Test:**
1. Create 100 test users (Free tier)
2. Each user performs 20 searches (limit is 20/day)
3. Verify all users hit limit correctly
4. Verify no user exceeds limit
5. Verify quota resets at midnight UTC

**Expected Results:**
- All users can perform exactly 20 searches
- 21st search blocked for all users
- Quota tracking accurate for all users
- No race conditions or double-counting

## Troubleshooting Integration Issues

### Issue: Search Results Differ

**Symptoms:**
- KB Portal returns different results than MCP Server
- Relevance scores don't match
- Document order differs

**Diagnosis:**
```bash
# Check embedding service URL
echo $EMBEDDING_SERVICE_URL

# Test embedding generation
curl -X POST $EMBEDDING_SERVICE_URL/embed \
  -H "Content-Type: application/json" \
  -d '{"text":"test query"}'

# Check database connection
psql $DATABASE_URL -c "SELECT COUNT(*) FROM documents WHERE embedding IS NOT NULL;"
```

**Solutions:**
1. Verify `EMBEDDING_SERVICE_URL` is identical in both `.env` files
2. Check embedding service is responding correctly
3. Verify database has embeddings for all documents
4. Clear search cache and retry

### Issue: Authentication Fails

**Symptoms:**
- User can log in to KB Portal but not Admin Portal
- API key doesn't work with MCP Server
- Session expires immediately

**Diagnosis:**
```bash
# Check Supabase configuration
echo $NEXT_PUBLIC_SUPABASE_URL
echo $NEXT_PUBLIC_SUPABASE_ANON_KEY

# Test authentication
curl -X POST $NEXT_PUBLIC_SUPABASE_URL/auth/v1/token \
  -H "apikey: $NEXT_PUBLIC_SUPABASE_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password"}'
```

**Solutions:**
1. Verify all portals use same `SUPABASE_URL`
2. Check API keys are correct
3. Verify RLS policies allow access
4. Check session expiry settings

### Issue: Quota Not Updating

**Symptoms:**
- User exceeds daily limit
- Quota shows incorrect count
- Quota doesn't reset at midnight

**Diagnosis:**
```sql
-- Check usage tracking
SELECT * FROM usage_tracking 
WHERE user_id = 'user-id-here' 
AND action_date = CURRENT_DATE;

-- Check tier limits
SELECT * FROM tier_limits WHERE tier = 'free';

-- Test track_usage function
SELECT track_usage('test-user-id', 'search', NULL);
```

**Solutions:**
1. Verify `usage_tracking` table is writable
2. Check RLS policies allow inserts
3. Verify `track_usage` function works
4. Check timezone settings (should be UTC)

### Issue: Documents Not Appearing

**Symptoms:**
- Document added in Admin Portal doesn't appear in KB Portal
- Search returns no results for new documents
- Embeddings missing

**Diagnosis:**
```sql
-- Check document exists
SELECT id, title, embedding IS NOT NULL as has_embedding 
FROM documents 
WHERE title ILIKE '%search-term%';

-- Check embedding dimensions
SELECT id, title, array_length(embedding, 1) as embedding_dim
FROM documents 
WHERE embedding IS NOT NULL
LIMIT 5;
```

**Solutions:**
1. Verify document was saved to database
2. Check embedding was generated (768-dim)
3. Verify search function includes new documents
4. Clear search cache

## Continuous Integration

### GitHub Actions Workflow

Create `.github/workflows/integration-tests.yml`:

```yaml
name: Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    
    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      EMBEDDING_SERVICE_URL: ${{ secrets.EMBEDDING_SERVICE_URL }}
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd kb-portal
          npm ci
      
      - name: Run integration tests
        run: |
          cd kb-portal
          npm run test:integration
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-results
          path: kb-portal/test-results/
```

## Monitoring Integration Health

### Health Check Endpoints

**KB Portal:**
```bash
curl http://localhost:3000/api/health
```

**MCP Server:**
```bash
curl http://localhost:8000/health
```

**EmbeddingGemma Service:**
```bash
curl $EMBEDDING_SERVICE_URL/health
```

### Metrics to Monitor

1. **Search Performance:**
   - Average response time
   - P95 response time
   - Error rate

2. **Authentication:**
   - Login success rate
   - Session duration
   - Token refresh rate

3. **Quota System:**
   - Quota check latency
   - Quota enforcement accuracy
   - Reset job success rate

4. **Database:**
   - Query performance
   - Connection pool utilization
   - Replication lag (if applicable)

5. **Embedding Service:**
   - Request latency
   - Throughput
   - Error rate

## Reporting Issues

When reporting integration issues, include:

1. **Environment:**
   - KB Portal version
   - MCP Server version
   - Node.js version
   - Database version

2. **Configuration:**
   - Relevant environment variables (redact secrets)
   - Deployment platform (Vercel, Railway, etc.)
   - Region/location

3. **Steps to Reproduce:**
   - Detailed steps
   - Expected behavior
   - Actual behavior
   - Screenshots/logs

4. **Test Results:**
   - Output from `verify-integration.ts`
   - Relevant error messages
   - Database query results

5. **Impact:**
   - Severity (critical, high, medium, low)
   - Affected users
   - Workaround (if any)

## Support

For integration support:

- **Email:** support@nabla.ai
- **Slack:** #nabla-integration
- **Documentation:** https://docs.nabla.ai/integration

## Appendix

### A. Environment Variables Reference

| Variable | KB Portal | MCP Server | Admin Portal | Required |
|----------|-----------|------------|--------------|----------|
| `NEXT_PUBLIC_SUPABASE_URL` | ✅ | ✅ | ✅ | Yes |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | ✅ | ❌ | ✅ | Yes |
| `SUPABASE_SERVICE_ROLE_KEY` | ✅ | ✅ | ✅ | Yes |
| `EMBEDDING_SERVICE_URL` | ✅ | ✅ | ✅ | Yes |
| `NEXT_PUBLIC_APP_URL` | ✅ | ❌ | ✅ | Yes |
| `API_KEYS` | ❌ | ✅ | ❌ | Yes (MCP) |
| `CLAUDE_API_KEY` | ❌ | ✅ | ❌ | Yes (AI tiers) |

### B. Database Schema Reference

**Shared Tables:**
- `documents` - Knowledge base documents
- `auth.users` - Supabase auth users
- `user_profiles` - Extended user profiles
- `tier_limits` - Tier configurations
- `usage_tracking` - Usage statistics
- `audit_log` - Audit trail
- `api_keys` - MCP Server API keys
- `subscriptions` - Subscription management

### C. API Endpoints Reference

**KB Portal:**
- `POST /api/search` - Semantic search
- `GET /api/documents/:id` - Get document
- `GET /api/usage` - Get usage stats
- `POST /api/auth/signup` - Sign up
- `POST /api/auth/login` - Log in

**MCP Server:**
- `POST /search_kb` - Search knowledge base
- `POST /get_document` - Get document by ID
- `POST /get_recent_updates` - Get recent documents
- `POST /consult_expert` - Consult virtual expert (AI tiers)

